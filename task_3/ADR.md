# Шаблон ADR

## Общая информация

| **Пункт**                 | **Значение**                                       |
|:--------------------------|:---------------------------------------------------|
| **Родительский артефакт** | ссылку на основную архитектуру или другой артефакт |
| **Автор ADR**             | Киценко Максим                                     |
| **Статус**                | В проработке                                       |
| **Согласующие**           | Ревьювер Спринта №5                                |

## Задача

Определить где необходимо разместить оркестратор процессов (Camunda BPMN)

## Контекст

MVP платёжного процесса уже развёрнут и включает базовую систему FraudCheck и функциональность возвратов.
SLA для успешных транзакций составляет менее пяти секунд в 90% случаев.
Платёжная система способна обрабатывать разные сценарии возвратов: автоматические возвраты при сбоях системы,
отмену по инициативе клиента и возвраты в случае обнаружения мошеннических операций, как в момент проведения транзакции,
так и пост-фактум.

При обсуждении архитектуры работы платёжной платформы с бизнесом и техническими экспертами выделены ключевые моменты:

- Сложность бизнес-процесса. В рамках одной транзакции задействовано несколько сервисов, которые выполняют как основные
  действия (списание средств, перевод контрагенту, отправка уведомлений), так и компенсирующие операции
  (возврат средств, откат статусов).
- Компенсационные транзакции. В случае сбоя на любом этапе (например, AML отклонил транзакцию после списания) необходимо
  инициировать возврат средств и уведомить клиента.
- State machine для управления Saga. Критически важно фиксировать текущее состояние процесса, чтобы обеспечивать
  корректное восстановление после ошибок. Также требуется хранить состояния с ожиданием ответа от сервисов проверок.
- Интеграция с внешними API. Все проверки должны выполняться с учётом таймаутов, retry-механизмов, идемпотентности
  и кэширования результатов.
- Мониторинг и трассировка. Платёжная система должна предоставлять бизнесу и службе безопасности прозрачный обзор хода
  транзакции, включая информацию о том, на каком этапе транзакция «зависла» или завершилась сбоем.

### Требования

- SLA для успешных транзакций составляет менее пяти секунд в 90% случаев.
- Необходимо учитывать, что сервис антифрод-проверок может возвращать три типа ответа:
    - Разрешение — транзакция может быть проведена.
    - Запрет — транзакция отклоняется.
    - Ручная проверка — транзакция направляется на рассмотрение оператору, который должен принять решение в течение 20
      минут.
    - По результатам ручной проверки сервис возвращает одно из окончательных решений: разрешение или запрет.
    - Соответственно на время ручной проверки транзакция должна находиться в состоянии ожидания. А если сервисы проверок
      не возвращают ответ в установленное время, то предусмотрен cut-off-time. По его истечении транзакция по умолчанию
      считается разрешённой и проводится.

### Критичные требования

- Нельзя допустить ситуации, когда деньги зависают между системами.
- Стоимость ошибки при проведении транзакции значительно выше, чем потенциальная потеря от её отклонения.
- Операции возврата должны выполняться автоматически, не привлекая службу поддержки в ручном режиме.

## Инструментарий:

Camunda BPMN — исполнение бизнес-процессов и реализация Saga-оркестрации с поддержкой компенсационных транзакций.

## Рассмотренные варианты

### Вариант №1 «На отдельном сервере»

Разместить BPMN-движок (оркестратор) на отдельно выделенном ресурсе.


### Вариант №2 «На сервере с одним из микросервисов»

Разместить BPMN-движок (оркестратор) (встроить) в сервис Заказов.

## Сравнение альтернатив

| Вариант решения                                  | Преимущества                                                               | Недостатки                                                                                  |
|--------------------------------------------------|----------------------------------------------------------------------------|---------------------------------------------------------------------------------------------|
| Вариант №1 «На отдельном сервере»                | - Выделенные ресурсы - лучшее быстродействие 1 <br> - Проще масштабировать | - Требует выделенных ресурсов<br> - Требуется реализации отельного микросервиса управления. |
| Вариант №2 «На сервере с одним из микросервисов» | - Требует меньше ресурсов <br>                                             | - В случае падения сервиса Заказов упадет и оркестратор <br> - Менее масштабируемый вариант |

## Принятое решение

Выбран Вариант №1

Выполняются следующие условия:
- В процессе участвуют три или даже более сервисов
- Есть принятый движок Camunda
- Требуются аудит, визуализация прогресса, операторские действия или ручные компенсирующие шаги.